<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slide Voice Maker - AIéŸ³å£°ä»˜ãå‹•ç”»ç”Ÿæˆãƒ„ãƒ¼ãƒ«ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆï¼‰</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        @keyframes aurora-1 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(20px, -20px) scale(1.1); } }
        @keyframes aurora-2 { 0%, 100% { transform: translate(0, 0) scale(1); } 50% { transform: translate(-20px, 10px) scale(1.2); } }
        .animate-aurora-1 { animation: aurora-1 15s infinite ease-in-out; }
        .animate-aurora-2 { animation: aurora-2 18s infinite ease-in-out; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-950">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰
        const isLocalMode = true;

        // Icons
        const Upload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
        const FileText = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>;
        const Play = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const Square = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>;
        const Video = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>;
        const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const Volume2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>;
        const HelpCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const ChevronLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>;
        const ChevronRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>;
        const Loader2 = ({ className }) => <svg className={className} xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>;
        const Wand2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/><path d="M11 3H9"/></svg>;

        // å­—å¹•ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²
        const getSubtitleSegments = (script) => {
            if (!script) return [];
            const rawSegments = script.split(/([ã€‚ã€ï¼ï¼Ÿ!?\n]+)/).filter(s => s.trim().length > 0);
            const mergedSegments = [];
            for (let i = 0; i < rawSegments.length; i += 2) {
                const text = rawSegments[i];
                const punctuation = rawSegments[i + 1] || "";
                mergedSegments.push(text + punctuation);
            }
            const totalChars = mergedSegments.reduce((acc, s) => acc + s.length, 0);
            let charCountAccumulator = 0;
            return mergedSegments.map(text => {
                const startRatio = charCountAccumulator / totalChars;
                charCountAccumulator += text.length;
                const endRatio = charCountAccumulator / totalChars;
                return { text, startRatio, endRatio };
            });
        };

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const fetchJson = async (url, options = {}, timeoutMs = 2000) => {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), timeoutMs);
            try {
                const res = await fetch(url, { ...options, signal: ctrl.signal });
                if (!res.ok) {
                    const text = await res.text().catch(() => '');
                    throw new Error(`${res.status} ${res.statusText}${text ? `: ${text}` : ''}`);
                }
                return await res.json();
            } finally {
                clearTimeout(t);
            }
        };

        // PlayerOverlay
        const PlayerOverlay = ({ currentSlide, audioRef, isPlaying }) => {
            const [currentSubtitle, setCurrentSubtitle] = useState("");
            const subtitleSegments = useMemo(() => getSubtitleSegments(currentSlide?.script), [currentSlide]);
            
            useEffect(() => {
                const audio = audioRef.current;
                if (!audio) return;
                const handleTimeUpdate = () => {
                    if (!currentSlide?.audio) { setCurrentSubtitle(""); return; }
                    const duration = audio.duration;
                    const currentTime = audio.currentTime;
                    if (!duration || !isFinite(duration)) return;
                    const currentRatio = currentTime / duration;
                    const activeSegment = subtitleSegments.find(seg => currentRatio >= seg.startRatio && currentRatio < seg.endRatio);
                    if (activeSegment) setCurrentSubtitle(activeSegment.text);
                    else if (currentRatio >= 1 && subtitleSegments.length > 0) setCurrentSubtitle(subtitleSegments[subtitleSegments.length - 1].text);
                };
                audio.addEventListener('timeupdate', handleTimeUpdate);
                return () => audio.removeEventListener('timeupdate', handleTimeUpdate);
            }, [audioRef, currentSlide, subtitleSegments]);
            
            return (
                <div className="w-full h-[80px] bg-[#1a1a2e] border-t border-white/5 flex items-center justify-center px-8 transition-colors duration-300 flex-shrink-0">
                    <div className="text-white text-lg md:text-2xl font-bold text-center leading-relaxed">{currentSubtitle}</div>
                </div>
            );
        };

        // Main App
        function SlideVoiceMaker() {
            const [slides, setSlides] = useState([]);
            const [scripts, setScripts] = useState([]);
            const [activeSlideIndex, setActiveSlideIndex] = useState(0);
            const [pdfLoading, setPdfLoading] = useState(false);
            const [showHelp, setShowHelp] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [isGeneratingAudio, setIsGeneratingAudio] = useState(false);
            const [pdfFile, setPdfFile] = useState(null);
            const [csvFile, setCsvFile] = useState(null);
            const [statusMessage, setStatusMessage] = useState('');
            const [selectedResolution, setSelectedResolution] = useState('720p');

            // Local backend state
            const [localBackendAvailable, setLocalBackendAvailable] = useState(false);
            const [savedPdfName, setSavedPdfName] = useState('');
            const [outputFiles, setOutputFiles] = useState([]);
            const [selectedOutputName, setSelectedOutputName] = useState('');
            
            // è§£åƒåº¦ãƒãƒƒãƒ”ãƒ³ã‚°
            const RESOLUTION_OPTIONS = [
                { label: '720p (1280x720)', value: '720p', width: 1280, height: 720 },
                { label: '1080p (1920x1080)', value: '1080p', width: 1920, height: 1080 },
                { label: '1440p (2560x1440)', value: '1440p', width: 2560, height: 1440 },
            ];
            
            const audioRef = useRef(null);
            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            const refreshOutputFiles = async () => {
                if (!localBackendAvailable) return;
                try {
                    const list = await fetchJson('/api/list_outputs', {}, 4000);
                    const files = (list && list.webm) ? list.webm : [];
                    setOutputFiles(files);
                    if (!selectedOutputName && files.length > 0) {
                        setSelectedOutputName(files[files.length - 1]);
                    }
                } catch (_) {
                    // noop
                }
            };

            const downloadSelectedWebm = () => {
                if (!localBackendAvailable) return;
                if (!selectedOutputName) {
                    setStatusMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹WebMã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                const a = document.createElement('a');
                a.href = `/api/download?name=${encodeURIComponent(selectedOutputName)}`;
                a.download = selectedOutputName;
                a.rel = 'noopener';
                document.body.appendChild(a);
                a.click();
                a.remove();
            };

            // åŸç¨¿CSVå‡ºåŠ›
            const downloadCsv = () => {
                if (slides.length === 0) {
                    setStatusMessage('ã‚¹ãƒ©ã‚¤ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                const lines = ['index,script'];
                slides.forEach((slide, i) => {
                    const escaped = (slide.script || '').replace(/"/g, '""');
                    lines.push(`${i},"${escaped}"`);
                });
                const csvContent = '\uFEFF' + lines.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'åŸç¨¿.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                setStatusMessage('åŸç¨¿CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            };

            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ¤œå‡º
            useEffect(() => {
                let cancelled = false;
                const check = async () => {
                    try {
                        const j = await fetchJson('/api/health', {}, 1200);
                        if (!cancelled && j && j.status === 'ok') setLocalBackendAvailable(true);
                    } catch (_) {
                        if (!cancelled) setLocalBackendAvailable(false);
                    }
                };
                check();
                return () => { cancelled = true; };
            }, []);

            // PDF to Images
            const convertPdfToImages = async (file) => {
                const pdfjsLib = window.pdfjsLib;
                if (!pdfjsLib.GlobalWorkerOptions.workerSrc) {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                }
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const images = [];
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport }).promise;
                    images.push(canvas.toDataURL('image/png'));
                }
                return images;
            };

            // CSV Parser (æ–‡å­—åŒ–ã‘å¯¾å‡¦ãƒ»ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œ)
            const parseCSV = async (file) => {
                const encodings = ['utf-8', 'utf-8-sig', 'shift_jis', 'euc-jp', 'iso-2022-jp'];
                const buf = await file.arrayBuffer();

                const decodeWith = (encoding) => {
                    try {
                        const dec = new TextDecoder(encoding, { fatal: false });
                        return dec.decode(buf);
                    } catch (_) {
                        return null;
                    }
                };

                // RFC 4180æœ€å°å¯¾å¿œï¼ˆè¤‡æ•°è¡Œã‚»ãƒ«/ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¼•ç”¨ç¬¦ï¼‰
                const parseText = (text) => {
                    const rows = [];
                    let row = [];
                    let field = '';
                    let inQuotes = false;

                    for (let i = 0; i < text.length; i++) {
                        const ch = text[i];
                        const next = text[i + 1];

                        if (ch === '"') {
                            if (inQuotes && next === '"') {
                                field += '"';
                                i++;
                            } else {
                                inQuotes = !inQuotes;
                            }
                            continue;
                        }

                        if (!inQuotes && (ch === ',' || ch === '\n' || ch === '\r')) {
                            row.push(field);
                            field = '';

                            if (ch === ',') {
                                continue;
                            }

                            if (ch === '\r' && next === '\n') i++;
                            rows.push(row);
                            row = [];
                            continue;
                        }

                        field += ch;
                    }

                    if (field.length > 0 || row.length > 0) {
                        row.push(field);
                        rows.push(row);
                    }

                    if (rows.length === 0) return [];

                    const header = rows[0].map(v => (v || '').trim().toLowerCase());
                    const idxCol = header.indexOf('index');
                    const scriptCol = header.indexOf('script');
                    if (idxCol === -1 || scriptCol === -1) return [];

                    const scripts = [];
                    for (let r = 1; r < rows.length; r++) {
                        const cols = rows[r];
                        if (!cols || cols.length === 0) continue;
                        const idxRaw = cols[idxCol];
                        const scriptRaw = cols[scriptCol];
                        const idx = Number.parseInt(String(idxRaw ?? '').trim(), 10);
                        if (Number.isNaN(idx)) continue;
                        const script = String(scriptRaw ?? '').trim();
                        scripts.push({ index: idx, script });
                    }
                    return scripts;
                };

                for (const encoding of encodings) {
                    const text = decodeWith(encoding);
                    if (!text) continue;

                    const replacementCount = (text.match(/\uFFFD/g) || []).length;
                    if (replacementCount > 0 && replacementCount / Math.max(text.length, 1) > 0.001) {
                        continue;
                    }

                    const scripts = parseText(text);
                    if (scripts.length > 0) return scripts;
                }

                throw new Error('CSVã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆUTF-8/Shift_JISç­‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰');
            };

            // Handle PDF Upload
            const handlePdfUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setPdfFile(file);
                setPdfLoading(true);
                setStatusMessage('PDFèª­ã¿è¾¼ã¿ä¸­...');
                try {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆ: input/ ã«PDFã‚’ä¸Šæ›¸ãä¿å­˜
                    if (localBackendAvailable) {
                        setStatusMessage('PDFã‚’input/ã¸ä¿å­˜ä¸­...');
                        const fd = new FormData();
                        fd.append('file', file);
                        const res = await fetch('/api/upload/pdf', { method: 'POST', body: fd });
                        if (!res.ok) throw new Error(`PDFä¿å­˜å¤±æ•—: ${res.status}`);
                        const j = await res.json();
                        setSavedPdfName(j.filename || file.name);
                        setStatusMessage('PDFä¿å­˜å®Œäº†ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­...');
                    } else {
                        setSavedPdfName(file.name);
                    }

                    const images = await convertPdfToImages(file);
                    const newSlides = images.map((image, index) => ({
                        id: crypto.randomUUID(),
                        image,
                        script: scripts[index]?.script || '',
                        audio: null,
                        isGenerating: false
                    }));
                    setSlides(newSlides);
                    setActiveSlideIndex(0);
                    setStatusMessage(`${images.length}ãƒšãƒ¼ã‚¸ã®PDFã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                } catch (error) {
                    setStatusMessage(`PDFèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`);
                } finally {
                    setPdfLoading(false);
                }
            };

            // Handle CSV Upload
            const handleCsvUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setCsvFile(file);
                setStatusMessage('åŸç¨¿CSVèª­ã¿è¾¼ã¿ä¸­...');
                try {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆ: input/ ã«CSVã‚’ä¸Šæ›¸ãä¿å­˜
                    if (localBackendAvailable) {
                        setStatusMessage('åŸç¨¿.csvã‚’input/ã¸ä¿å­˜ä¸­...');
                        const fd = new FormData();
                        fd.append('file', file);
                        const res = await fetch('/api/upload/csv', { method: 'POST', body: fd });
                        if (!res.ok) throw new Error(`CSVä¿å­˜å¤±æ•—: ${res.status}`);
                        setStatusMessage('CSVä¿å­˜å®Œäº†ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§åŸç¨¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åæ˜ ä¸­...');
                    }

                    const parsedScripts = await parseCSV(file);
                    setScripts(parsedScripts);
                    
                    // ã‚¹ãƒ©ã‚¤ãƒ‰ãŒã‚ã‚Œã°åŸç¨¿ã‚’é©ç”¨
                    if (slides.length > 0) {
                        setSlides(prev => prev.map((slide, index) => ({
                            ...slide,
                            script: parsedScripts.find(s => s.index === index)?.script || slide.script,
                            audio: null
                        })));
                    }
                    setStatusMessage(`${parsedScripts.length}ä»¶ã®åŸç¨¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                } catch (error) {
                    setStatusMessage(`CSVèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`);
                }
            };

            // Generate All Audio (ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰çµŒç”±)
            const generateAllAudio = async () => {
                if (isGeneratingAudio) return;

                if (!localBackendAvailable) {
                    setStatusMessage('ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆsrc/server.pyï¼‰ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                    return;
                }

                if (!savedPdfName) {
                    setStatusMessage('å…ˆã«PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                    return;
                }

                setIsGeneratingAudio(true);
                setStatusMessage('éŸ³å£°ç”Ÿæˆ & å‹•ç”»ç”Ÿæˆä¸­ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰...');
                try {
                    const body = JSON.stringify({ pdf_name: savedPdfName, resolution: selectedResolution });
                    const res = await fetchJson('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body }, 600000);
                    const list = await fetchJson('/api/list_outputs', {}, 4000);
                    const files = (list && list.webm) ? list.webm : [];
                    setOutputFiles(files);

                    const preferred = res && res.webm ? res.webm : '';
                    if (preferred && files.includes(preferred)) {
                        setSelectedOutputName(preferred);
                    } else if (files.length > 0) {
                        setSelectedOutputName(files[files.length - 1]);
                    }

                    setStatusMessage('ç”Ÿæˆå®Œäº†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã€‚output/ ã«å‹•ç”»ã‚’æ›¸ãè¾¼ã¿ã¾ã—ãŸã€‚');
                } catch (e) {
                    setStatusMessage(`ç”Ÿæˆå¤±æ•—: ${e.message}`);
                } finally {
                    setIsGeneratingAudio(false);
                }
            };

            // Update script
            const updateScript = (index, newScript) => {
                setSlides(prev => {
                    const newSlides = [...prev];
                    newSlides[index] = { ...newSlides[index], script: newScript, audio: null };
                    return newSlides;
                });
            };

            // åˆæœŸç”»é¢ï¼ˆPDFæœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
            if (slides.length === 0) {
                return (
                    <div className="min-h-screen bg-slate-950 text-white flex flex-col items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute top-[-10%] left-[-10%] w-[500px] h-[500px] bg-violet-600/30 rounded-full blur-[100px] animate-aurora-1" />
                        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-fuchsia-600/20 rounded-full blur-[120px] animate-aurora-2" />
                        
                        <div className="z-10 bg-slate-900/60 backdrop-blur-xl border border-white/10 p-12 rounded-3xl shadow-2xl max-w-2xl w-full text-center">
                            <div className="mb-8 flex justify-center">
                                <div className="bg-gradient-to-r from-violet-500 to-fuchsia-500 p-4 rounded-2xl shadow-lg shadow-violet-500/20">
                                    <Video />
                                </div>
                            </div>
                            <h1 className="text-4xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-violet-400 to-fuchsia-400">
                                Slide Voice Maker
                            </h1>
                            <p className="text-lg text-slate-300 mb-2">
                                PDFã‚¹ãƒ©ã‚¤ãƒ‰ã¨åŸç¨¿CSVã‹ã‚‰<br/>ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãå‹•ç”»ã‚’ç”Ÿæˆ
                            </p>
                            <p className="text-sm text-slate-500 mb-8">
                                ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆï¼ˆsrc/server.pyèµ·å‹•æ™‚ã«éŸ³å£°ç”Ÿæˆå¯èƒ½ï¼‰
                            </p>
                            
                            {/* ãƒ›ãƒ¼ãƒ ç”»é¢ã¯PDFå…¥åŠ›ãƒœã‚¿ãƒ³ã®ã¿ */}
                            <div className="space-y-4 mb-8">
                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    disabled={pdfLoading}
                                    className="w-full px-6 py-4 bg-white text-slate-900 rounded-xl font-bold text-lg hover:bg-slate-100 transition-all flex items-center justify-center gap-3"
                                >
                                    {pdfLoading ? (
                                        <><Loader2 className="loading-spinner" /> PDFèª­ã¿è¾¼ã¿ä¸­...</>
                                    ) : (
                                        <><Upload /> PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</>
                                    )}
                                </button>
                                <input type="file" ref={fileInputRef} onChange={handlePdfUpload} accept=".pdf" className="hidden" />
                            </div>
                            
                            {statusMessage && (
                                <div className="text-sm text-slate-400 mb-4">{statusMessage}</div>
                            )}

                            {!localBackendAvailable && (
                                <div className="text-sm text-orange-400 mt-4">
                                    âš ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœªæ¤œå‡º<br/>
                                    éŸ³å£°ç”Ÿæˆã«ã¯ py -3.10 -m uvicorn src.server:app ã‚’èµ·å‹•ã—ã¦ãã ã•ã„
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            const activeSlide = slides[activeSlideIndex];

            return (
                <div className="h-screen bg-slate-950 text-slate-200 flex flex-col overflow-hidden">
                    
                    {/* Header */}
                    <header className="h-16 bg-slate-900/80 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-6 z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-gradient-to-br from-violet-500 to-fuchsia-600 rounded-lg flex items-center justify-center">
                                <Video />
                            </div>
                            <h1 className="font-bold text-lg">Slide Voice Maker</h1>
                            <button onClick={() => setShowHelp(true)} className="ml-2 text-slate-400 hover:text-white">
                                <HelpCircle />
                            </button>
                        </div>
                        
                        <div className="flex items-center gap-3">
                            {/* ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œãƒœã‚¿ãƒ³ */}
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm border border-white/10"
                            >
                                <Upload /> PDF
                            </button>
                            <input type="file" ref={fileInputRef} onChange={handlePdfUpload} accept=".pdf" className="hidden" />
                            
                            <button
                                onClick={() => csvInputRef.current?.click()}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm border border-white/10"
                            >
                                <FileText /> åŸç¨¿CSVå…¥åŠ›
                            </button>
                            <input type="file" ref={csvInputRef} onChange={handleCsvUpload} accept=".csv" className="hidden" />
                            
                            <div className="h-6 w-px bg-white/10 mx-1" />
                            
                            {/* è§£åƒåº¦é¸æŠ */}
                            <select
                                value={selectedResolution}
                                onChange={(e) => setSelectedResolution(e.target.value)}
                                className="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm border border-white/10 cursor-pointer"
                            >
                                {RESOLUTION_OPTIONS.map(opt => (
                                    <option key={opt.value} value={opt.value}>{opt.label}</option>
                                ))}
                            </select>
                            
                            {/* éŸ³å£°ç”Ÿæˆãƒœã‚¿ãƒ³ */}
                            <button
                                onClick={generateAllAudio}
                                disabled={isGeneratingAudio || !localBackendAvailable}
                                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-all ${
                                    isGeneratingAudio 
                                        ? 'bg-slate-800 text-slate-400 cursor-wait' 
                                        : localBackendAvailable
                                            ? 'bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20'
                                            : 'bg-slate-800 text-slate-500 cursor-not-allowed'
                                }`}
                                title={localBackendAvailable ? 'ãƒ­ãƒ¼ã‚«ãƒ«ã§éŸ³å£°+å‹•ç”»ã‚’ç”Ÿæˆã—ã€output/ã¸ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™' : 'ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“'}
                            >
                                {isGeneratingAudio ? (
                                    <><Loader2 className="loading-spinner" /> ç”Ÿæˆä¸­...</>
                                ) : (
                                    <><Wand2 /> éŸ³å£°ç”Ÿæˆ</>
                                )}
                            </button>

                            <div className="h-6 w-px bg-white/10 mx-1" />

                            {/* åŸç¨¿CSVå‡ºåŠ›ãƒœã‚¿ãƒ³ */}
                            <button
                                onClick={downloadCsv}
                                className="flex items-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm border border-white/10"
                                title="ç·¨é›†ã—ãŸåŸç¨¿ã‚’CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                            >
                                <Download /> åŸç¨¿CSVå‡ºåŠ›
                            </button>

                            {/* å‹•ç”»WebMå‡ºåŠ›ãƒœã‚¿ãƒ³ */}
                            {localBackendAvailable && (
                                <>
                                    <select
                                        value={selectedOutputName}
                                        onChange={(e) => setSelectedOutputName(e.target.value)}
                                        onFocus={refreshOutputFiles}
                                        className="px-3 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm border border-white/10 cursor-pointer"
                                        title="output/ ã«ã‚ã‚‹WebMã‚’é¸æŠ"
                                    >
                                        <option value="">(output/*.webm ã‚’é¸æŠ)</option>
                                        {outputFiles.map(n => (
                                            <option key={n} value={n}>{n}</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={downloadSelectedWebm}
                                        disabled={!selectedOutputName}
                                        className="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 text-white rounded-lg text-sm disabled:opacity-50"
                                        title="é¸æŠã—ãŸWebMã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                                    >
                                        <Download /> å‹•ç”»WebMå‡ºåŠ›
                                    </button>
                                </>
                            )}
                        </div>
                    </header>
                    
                    {/* Status Message */}
                    {statusMessage && (
                        <div className="bg-slate-900/50 border-b border-white/5 px-6 py-2 text-sm text-slate-400">
                            {statusMessage}
                        </div>
                    )}
                    
                    {/* Main Content */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* Sidebar */}
                        <div className="w-64 bg-slate-900 border-r border-white/5 flex flex-col">
                            <div className="p-4 border-b border-white/5">
                                <h2 className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Slides ({slides.length})
                                </h2>
                            </div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                                {slides.map((slide, index) => (
                                    <button
                                        key={slide.id}
                                        onClick={() => setActiveSlideIndex(index)}
                                        className={`w-full text-left p-2 rounded-lg transition-all border ${
                                            activeSlideIndex === index
                                                ? 'bg-slate-800 border-violet-500/50 shadow-md'
                                                : 'hover:bg-slate-800/50 border-transparent hover:border-white/5'
                                        }`}
                                    >
                                        <div className="flex gap-3">
                                            <div className="relative w-16 aspect-video bg-slate-950 rounded overflow-hidden border border-white/10 flex-shrink-0">
                                                <img src={slide.image} className="w-full h-full object-cover" alt={`Slide ${index + 1}`} />
                                                {slide.isGenerating && (
                                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                                                        <Loader2 className="loading-spinner text-white" />
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0 flex flex-col justify-center">
                                                <span className="text-sm font-medium text-slate-300 truncate">Slide {index + 1}</span>
                                                <div className="flex items-center gap-2 mt-1">
                                                    {slide.audio ? (
                                                        <span className="text-[10px] flex items-center gap-1 text-green-400"><Volume2 /> Audio</span>
                                                    ) : (
                                                        <span className="text-[10px] flex items-center gap-1 text-orange-400"><FileText /> Text</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Preview Area */}
                        <div className="flex-1 flex flex-col bg-slate-950 relative overflow-hidden">
                            <div className="flex-1 flex flex-col min-h-0">
                                <div className="flex-1 bg-slate-950 relative flex items-center justify-center p-4">
                                    <div className="relative w-full h-full max-w-5xl flex flex-col items-center justify-center group">
                                        <div className="relative shadow-2xl rounded-lg overflow-hidden border border-slate-800 bg-black flex-shrink-1 min-h-0">
                                            <img src={activeSlide?.image} className="max-w-full max-h-[calc(100vh-400px)] object-contain mx-auto" alt="Slide Preview" />
                                            <audio 
                                                ref={audioRef} 
                                                src={activeSlide?.audio || ""} 
                                                onPlay={() => setIsPlaying(true)} 
                                                onPause={() => setIsPlaying(false)} 
                                                onEnded={() => { setIsPlaying(false); if(audioRef.current) audioRef.current.currentTime = 0; }} 
                                            />
                                            {activeSlide?.audio && (
                                                <div className={`absolute inset-0 flex items-center justify-center transition-opacity duration-300 ${isPlaying ? 'opacity-0 group-hover:opacity-100' : 'opacity-100'}`}>
                                                    <button
                                                        onClick={() => {
                                                            const audio = audioRef.current;
                                                            if (!audio) return;
                                                            if (isPlaying) audio.pause();
                                                            else audio.play().catch(() => {});
                                                        }}
                                                        className="w-16 h-16 bg-violet-600/90 hover:bg-violet-500 text-white rounded-full flex items-center justify-center shadow-xl backdrop-blur-sm transition-transform hover:scale-105"
                                                    >
                                                        {isPlaying ? <Square /> : <Play />}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    
                                    {/* Navigation */}
                                    <div className="absolute inset-x-4 top-1/2 -translate-y-1/2 flex justify-between pointer-events-none">
                                        <button
                                            onClick={() => setActiveSlideIndex(Math.max(0, activeSlideIndex - 1))}
                                            disabled={activeSlideIndex === 0}
                                            className="pointer-events-auto p-3 rounded-full bg-slate-900/50 hover:bg-slate-800 text-slate-300 backdrop-blur-sm transition-all disabled:opacity-0"
                                        >
                                            <ChevronLeft />
                                        </button>
                                        <button
                                            onClick={() => setActiveSlideIndex(Math.min(slides.length - 1, activeSlideIndex + 1))}
                                            disabled={activeSlideIndex === slides.length - 1}
                                            className="pointer-events-auto p-3 rounded-full bg-slate-900/50 hover:bg-slate-800 text-slate-300 backdrop-blur-sm transition-all disabled:opacity-0"
                                        >
                                            <ChevronRight />
                                        </button>
                                    </div>
                                </div>
                                
                                <PlayerOverlay currentSlide={activeSlide} audioRef={audioRef} isPlaying={isPlaying} />
                                
                                <div className="h-8 bg-slate-900 border-t border-b border-white/5 flex items-center justify-center gap-4 text-xs text-slate-500 font-mono">
                                    <span>SLIDE {String(activeSlideIndex + 1).padStart(2, '0')} / {String(slides.length).padStart(2, '0')}</span>
                                </div>
                            </div>
                            
                            {/* Script Editor */}
                            <div className="h-[200px] bg-slate-900 flex flex-col flex-shrink-0">
                                <div className="flex items-center justify-between px-4 py-2 border-b border-white/5 bg-slate-900/50">
                                    <span className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                        <FileText /> Narration Script
                                    </span>
                                    <span className="text-xs text-slate-600">{activeSlide?.script?.length || 0} characters</span>
                                </div>
                                <textarea
                                    value={activeSlide?.script || ""}
                                    onChange={(e) => updateScript(activeSlideIndex, e.target.value)}
                                    className="flex-1 bg-slate-900 p-4 text-slate-300 text-lg leading-relaxed resize-none focus:outline-none focus:bg-slate-800/50 transition-colors"
                                    placeholder="ã“ã“ã«èª­ã¿ä¸Šã’åŸç¨¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
                                />
                            </div>
                        </div>
                    </div>
                    
                    {/* Help Modal */}
                    {showHelp && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-white/10 rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden">
                                <div className="flex items-center justify-between p-6 border-b border-white/10">
                                    <h3 className="text-xl font-bold text-white">ğŸ”® ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h3>
                                    <button onClick={() => setShowHelp(false)} className="text-slate-400 hover:text-white"><X /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                                        <h4 className="font-bold text-violet-400 mb-2">[STEP 1] PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h4>
                                        <p className="text-sm text-slate-300">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³PDFã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã€å„ãƒšãƒ¼ã‚¸ãŒã‚¹ãƒ©ã‚¤ãƒ‰ã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚Œã¾ã™ã€‚<br/>ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•æ™‚ã¯input/ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
                                    </div>
                                    <div className="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                                        <h4 className="font-bold text-violet-400 mb-2">[STEP 2] åŸç¨¿CSVèª­ã¿è¾¼ã¿</h4>
                                        <p className="text-sm text-slate-300">ã€Œindex,scriptã€å½¢å¼ã®CSVã‚’èª­ã¿è¾¼ã‚€ã¨ã€å„ã‚¹ãƒ©ã‚¤ãƒ‰ã«åŸç¨¿ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã™ã€‚UTF-8/Shift_JISå¯¾å¿œã€‚</p>
                                    </div>
                                    <div className="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                                        <h4 className="font-bold text-violet-400 mb-2">[STEP 3] éŸ³å£°ç”Ÿæˆ & å‹•ç”»å‡ºåŠ›</h4>
                                        <p className="text-sm text-slate-300">ã€ŒéŸ³å£°ç”Ÿæˆã€ã§Edge TTSã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã®AIéŸ³å£°ã‚’ç”Ÿæˆã—ã€output/ã«å‹•ç”»WebMã‚’ä¿å­˜ã—ã¾ã™ã€‚</p>
                                        <p className="text-xs text-slate-400 mt-2">
                                            ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èµ·å‹•: py -3.10 -m uvicorn src.server:app
                                        </p>
                                    </div>
                                    <div className="bg-slate-800/50 rounded-lg p-4 border border-white/5">
                                        <h4 className="font-bold text-violet-400 mb-2">[STEP 4] ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h4>
                                        <p className="text-sm text-slate-300">ã€ŒåŸç¨¿CSVå‡ºåŠ›ã€ã§ç·¨é›†ã—ãŸåŸç¨¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€‚ã€Œå‹•ç”»WebMå‡ºåŠ›ã€ã§ç”Ÿæˆã—ãŸå‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</p>
                                    </div>
                                </div>
                                <div className="p-4 bg-slate-950 border-t border-white/5 flex justify-end">
                                    <button onClick={() => setShowHelp(false)} className="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg">é–‰ã˜ã‚‹</button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                </div>
            );
        }

        // Render
        ReactDOM.createRoot(document.getElementById('root')).render(<SlideVoiceMaker />);
    </script>
</body>
</html>
